<!DOCTYPE html>
<html lang="en">

<head>
    <title>three.js webgl - geometry - cube</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
        integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <link rel="stylesheet" href="css/styles.css">
</head>

<body>
    <script type="module">
        import * as THREE from './js/three.module.js';
        import { OrbitControls } from './js/OrbitControls.js';

        // set scale sliders
        let scalars = [16, 16, 16];

        function updateSliders() {
            $('slider-x-value').value = scalars[0] = $('slider-x').value;
            $('slider-y-value').value = scalars[1] = $('slider-y').value;
            $('slider-z-value').value = scalars[2] = $('slider-z').value;
            loadPrefab();
        }

        function initSliders() {
            $('slider-x').value = $('slider-x-value').value = scalars[0];
            $('slider-y').value = $('slider-y-value').value = scalars[1];
            $('slider-z').value = $('slider-z-value').value = scalars[2];

            $('slider-x').addEventListener("change", updateSliders);
            $('slider-y').addEventListener("change", updateSliders);
            $('slider-z').addEventListener("change", updateSliders);
        }

        initSliders();

        var camera, scene, renderer, controls;
        const view_depth = 20000;
        const blockSize = 100;
        const heightOffset = 1000;

        const loader = new THREE.CubeTextureLoader();
        const texture = loader.load([
            'img/sky.jpg',
            'img/sky.jpg',
            'img/sky_blue.jpg',
            'img/sky.jpg',
            'img/sky.jpg',
            'img/sky.jpg',
        ]);

        function showPrefab(name) {
            if (renderer && renderer.domElement)
                document.body.removeChild(renderer.domElement);
            if (name.endsWith(".tts"))
                name = name.replace(".tts", "");
            get(`/api/tts/${name}?size=${scalars.join(',')}`, function (prefab) {
                console.log(prefab);
                const size = [prefab.size_x, prefab.size_y, prefab.size_z];
                
                const avgSize = (size[0] + size[1] + size[2]) / 3;
                const offset = (blockSize * avgSize) / 2;

                init();
                animate();

                function init() {
                    camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 1, view_depth);
                    camera.position.z = 3000;

                    scene = new THREE.Scene();
                    scene.background = texture;

                    var light = new THREE.AmbientLight(0xCCCCCC);
                    scene.add(light);

                    var groundGeometry = new THREE.BoxGeometry(blockSize * 200, blockSize, blockSize * 200);

                    var groundTexture = new THREE.TextureLoader().load('img/grass.jpg');
                    groundTexture.wrapS = groundTexture.wrapT = THREE.RepeatWrapping;
                    groundTexture.repeat.set(16, 16);

                    var groundMaterial = new THREE.MeshBasicMaterial({ map: groundTexture });
                    // const groundMaterial = new THREE.MeshPhongMaterial({
                    //                     color: `rgb(192,128,0)`,
                    //                     flatShading: true,
                    //                 });
                    const groundMesh = new THREE.Mesh(groundGeometry, groundMaterial);
                    scene.add(groundMesh);
                    groundMesh.position.set(
                        0,
                        -100,
                        0);

                    var geometry = new THREE.BoxGeometry(blockSize, blockSize, blockSize);
                    var prefabGeo = new THREE.Geometry();

                    // var texture = new THREE.TextureLoader().load('img/crate.gif');
                    // var material = new THREE.MeshBasicMaterial({ map: texture });
                    for (let x = 0; x < size[0]; x++) {
                        for (let y = 0; y < size[1]; y++) {
                            for (let z = 0; z < size[2]; z++) {
                                const g = prefab.layers[z][y][x] % 256;
                                if (g) {
                                    const c = g < 32 ?
                                        `rgb(${g},${g},0)` :
                                        `rgb(${g},${g},${g})`;
                                    const material = new THREE.MeshPhongMaterial({
                                        color: c,
                                        flatShading: true,
                                    });
                                    const mesh = new THREE.Mesh(geometry, material);
                                    mesh.position.set(
                                        blockSize * x - offset,
                                        blockSize * y - offset + heightOffset,
                                        blockSize * z - offset);
                                    mesh.updateMatrix();
                                    prefabGeo.merge(mesh.geometry, mesh.matrix);
                                }
                            }
                        }
                    }

                    var material = new THREE.MeshPhongMaterial({color: 0xFF0000});
                    var mesh = new THREE.Mesh(prefabGeo, material);
                    scene.add(mesh);

                    renderer = new THREE.WebGLRenderer({ antialias: true });
                    renderer.setPixelRatio(window.devicePixelRatio);
                    renderer.setSize(window.innerWidth, window.innerHeight);
                    document.body.appendChild(renderer.domElement);

                    controls = new OrbitControls(camera, renderer.domElement);
                    controls.update();

                    window.addEventListener('resize', onWindowResize, false);
                }

                function onWindowResize() {
                    camera.aspect = window.innerWidth / window.innerHeight;
                    camera.updateProjectionMatrix();
                    renderer.setSize(window.innerWidth, window.innerHeight);
                }

                function animate() {
                    requestAnimationFrame(animate);
                    renderer.render(scene, camera);
                    controls.update();
                }
            });
        }

        function loadPrefab() {
            console.log('prefab select value: ', $('tts-select').value);
            showPrefab($('tts-select').value);
        }

        get("/api/data/alltts", function (files) {
            let s = $('tts-select');
            files.forEach(function (file) {
                var option = document.createElement('option');
                option.text = file;
                option.value = file;
                if (file == 'trailer_03.tts')
                    option.selected = true;
                s.add(option);
            });
            console.log('prefab select value: ', s.value);
            s.addEventListener("change", loadPrefab);
            loadPrefab();
        });

        function get(url, handler) {
            var xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function () {
                if (this.readyState == 4 && this.status == 200) {
                    const result = JSON.parse(xhttp.responseText);
                    handler(result);
                }
            };
            xhttp.open("GET", url, true);
            xhttp.send();
        }

        // utilities

        function $(id) {
            return document.getElementById(id);
        }

    </script>
    <select id="tts-select" class="form-control col-md-2"></select>
    <div id="scale-sliders" class="control-panel">
        <div>
            <label for="slider-x">X</label>
            <input type="range" id="slider-x" min="8" max="64" />
            <input type="text" id="slider-x-value" class="slider-value" />
        </div>
        <div>
            <label for="slider-y">Y</label>
            <input type="range" id="slider-y" min="8" max="64">
            <input type="text" id="slider-y-value" class="slider-value" />
        </div>
        <div>
            <label for="slider-z">Z</label>
            <input type="range" id="slider-z" min="8" max="64">
            <input type="text" id="slider-z-value" class="slider-value" />
        </div>
    </div>
</body>

</html>